language: node_js
node_js:
- 6.14.0
branches:
  only:
  - master


script:
  # Delete the original firebase.json (designed for local development machines)
  - rm -rf $TRAVIS_BUILD_DIR/firebase.json
  # Renaming the firebase.deploy.json (designed for build machines) to firebase.json
  - mv $TRAVIS_BUILD_DIR/firebase.deploy.json $TRAVIS_BUILD_DIR/firebase.json
  # Delete the original package.json (designed for local development machines)
  - rm -rf $TRAVIS_BUILD_DIR/$FIREBASE_PRODUCT/package.json
  # Renaming the package.linux.json / package.windows.json (designed for linux/windows based build machines) to package.json
  - mv $TRAVIS_BUILD_DIR/$FIREBASE_PRODUCT/package.$BUILD_MACHINE_OS_TYPE.json $TRAVIS_BUILD_DIR/functions/package.json
  # npm install packages from packages.json
  - npm --prefix $TRAVIS_BUILD_DIR/$FIREBASE_PRODUCT install
  # Run the firebase build
  - npm --prefix $TRAVIS_BUILD_DIR/$FIREBASE_PRODUCT run build
  # Install the firebase tools
  - npm install -g firebase-tools

before_deploy: 
  # Setting up configuration keys for the firebase function deployment
  - firebase functions:config:set gmail.email="$FROM_EMAIL" gmail.password="$FROM_EMAIL_PASSWORD" bcc.email_list="$BCC_EMAIL_RECIPIENT" --token "$FIREBASE_TOKEN"

deploy:
  provider: firebase
  token:
    secure: "$FIREBASE_ENCRYPTED_TOKEN"
  skip_cleanup: true